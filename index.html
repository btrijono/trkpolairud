<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Peta Plotting dengan Export PDF</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  #map { height: 90vh; width: 100%; }
  .title-print {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    font-weight: bold;
    font-size: 20px;
    background: rgba(255,255,255,0.8);
    padding: 5px 10px;
    border-radius: 4px;
    z-index: 1000;
  }
</style>
</head>
<body>

<div id="map"></div>

<!-- Tambah tombol export PDF -->
<button id="exportPDF" style="position:absolute; top:10px; left:10px; z-index:1000;">
Export PDF
</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
let map = L.map('map').setView([-0.7893, 113.9213], 8);
let pointCounter = 0;
let points = [];
let titleDiv = null;

// Background map
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

// Fungsi tambah titik
function addPoint(lat, lng) {
    pointCounter++;
    const pointNumber = pointCounter;

    // Marker tanda plus dalam lingkaran
    const marker = L.marker([lat, lng], {
        icon: L.divIcon({
            html: `<div style="width: 24px; height: 24px; border: 2px solid red; border-radius: 50%; 
                    background-color: white; display: flex; align-items: center; justify-content: center;
                    font-size: 18px; color: red;">+</div>`,
            className: ''
        })
    }).addTo(map);

    // Label nomor titik
    L.marker([lat, lng], {
        icon: L.divIcon({
            html: `<b style="color:black; background:rgba(255,255,255,0.7); padding:1px 4px; 
                    border-radius:4px; font-size:12px;">
                    ${pointNumber}</b>`,
            className: '',
            iconAnchor: [-5, -20]
        }),
        interactive: false
    }).addTo(map);

    points.push({ lat, lng, number: pointNumber });
}

// Event klik peta
map.on('click', function(e) {
    addPoint(e.latlng.lat, e.latlng.lng);
});

// Fungsi Export PDF
document.getElementById('exportPDF').addEventListener('click', async function() {
    let title = prompt("Masukkan Judul Peta:");
    if (!title) return;
    title = title.toUpperCase();

    // Buat div judul di peta
    if (titleDiv) {
        titleDiv.remove();
    }
    titleDiv = document.createElement('div');
    titleDiv.className = 'title-print';
    titleDiv.innerText = title;
    document.body.appendChild(titleDiv);

    // Tunggu sedikit biar judul muncul
    await new Promise(r => setTimeout(r, 500));

    // Tangkap peta
    const mapCanvas = await html2canvas(document.getElementById('map'), {useCORS:true});
    const imgData = mapCanvas.toDataURL('image/png');

    // Buat PDF
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('landscape', 'pt', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, pageHeight);
    pdf.save('peta.pdf');

    // Hapus judul setelah export
    titleDiv.remove();
});
</script>

</body>
</html>
