<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Plotting Titik dengan PDF</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { height: 70vh; width: 100%; }
    #controls {
        background: #f8f8f8;
        padding: 4px;
        font-size: 12px;
        border-bottom: 1px solid #ccc;
    }
    #controls button, #controls input {
        font-size: 12px;
        padding: 2px 6px;
        margin: 1px;
    }
    #pointTable {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }
    #pointTable th, #pointTable td {
        border: 1px solid #ccc;
        padding: 4px;
        text-align: center;
    }
    #pointTable input {
        width: 90%;
        font-size: 12px;
        padding: 2px;
    }
</style>
</head>
<body>

<div id="controls">
    Judul Peta: <input type="text" id="mapTitle" placeholder="Masukkan Judul" />
    <button onclick="toggleMenu()">Toggle Menu</button>
    <button onclick="exportJSON()">Export JSON</button>
    <input type="file" id="importFile" onchange="importJSON(event)" />
    <button onclick="exportPDF()">Export PDF</button>
</div>

<div id="map"></div>

<h3 style="margin:4px; font-size:14px;">Daftar Titik</h3>
<table id="pointTable">
    <thead>
        <tr>
            <th>No</th>
            <th>Nama Titik</th>
            <th>Latitude</th>
            <th>Longitude</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- html2canvas & jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
let map = L.map('map').setView([-2.5, 118], 5);
let baseLayers = {
    "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}),
    "Satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
};
baseLayers["OpenStreetMap"].addTo(map);
L.control.layers(baseLayers).addTo(map);

let points = [];
let pointCounter = 0;

map.on('click', function(e){
    addPoint(e.latlng.lat, e.latlng.lng, "Titik " + (pointCounter+1));
});

function addPoint(lat, lng, name) {
    pointCounter++;
    let number = pointCounter;

    let marker = L.marker([lat, lng], {
        icon: L.divIcon({
            html: `<div style="width: 20px; height: 20px; border: 2px solid red; border-radius: 50%; 
                    background: white; display: flex; align-items: center; justify-content: center; color:red;">+</div>`,
            className: ''
        })
    }).addTo(map);

    let label = L.marker([lat, lng], {
        icon: L.divIcon({
            html: `<b style="background: rgba(255,255,255,0.7); padding:1px 4px; border-radius:4px; font-size:10px;">${number}</b>`,
            className: '',
            iconAnchor: [-5, -20]
        }),
        interactive: false
    }).addTo(map);

    points.push({number, name, lat, lng, marker, label});
    updateTable();
}

function updateTable(){
    let tbody = document.querySelector("#pointTable tbody");
    tbody.innerHTML = "";
    points.forEach((p, idx)=>{
        let row = document.createElement("tr");
        row.innerHTML = `
            <td>${p.number}</td>
            <td><input type="text" value="${p.name}" onchange="editName(${idx}, this.value)" /></td>
            <td>${p.lat.toFixed(6)}</td>
            <td>${p.lng.toFixed(6)}</td>
        `;
        tbody.appendChild(row);
    });
}

function editName(index, newName){
    points[index].name = newName;
}

function toggleMenu(){
    let controls = document.getElementById("controls");
    controls.style.display = (controls.style.display === "none") ? "block" : "none";
}

function exportJSON(){
    let data = points.map(p => ({number:p.number, name:p.name, lat:p.lat, lng:p.lng}));
    let blob = new Blob([JSON.stringify(data)], {type: "application/json"});
    let url = URL.createObjectURL(blob);
    let a = document.createElement("a");
    a.href = url;
    a.download = "titik.json";
    a.click();
}

function importJSON(event){
    let file = event.target.files[0];
    if(!file) return;
    let reader = new FileReader();
    reader.onload = function(e){
        let data = JSON.parse(e.target.result);
        points.forEach(p => { map.removeLayer(p.marker); map.removeLayer(p.label); });
        points = [];
        pointCounter = 0;
        data.forEach(d => addPoint(d.lat, d.lng, d.name));
    };
    reader.readAsText(file);
}

async function exportPDF(){
    let title = document.getElementById("mapTitle").value.toUpperCase();
    let mapElement = document.getElementById("map");
    let canvas = await html2canvas(mapElement, {useCORS:true, scale:2});
    let imgData = canvas.toDataURL('image/png');

    const { jsPDF } = window.jspdf;
    let pdf = new jsPDF({orientation: "landscape", unit: "mm", format: "a4"});
    pdf.setFontSize(14);
    pdf.text(title, 10, 10);
    let imgWidth = 280; // lebar sesuai A4 landscape
    let imgHeight = canvas.height * imgWidth / canvas.width;
    pdf.addImage(imgData, 'PNG', 10, 15, imgWidth, imgHeight);
    pdf.save("peta.pdf");
}
</script>

</body>
</html>
