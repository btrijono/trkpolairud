<!DOCTYPE html>
<html>
<head>
    <title>Leaflet - Plot Titik dengan Ekspor/Impor</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <style>
        #map { height: 100vh; }
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 6px rgba(0,0,0,0.3);
        }
        .plus-marker {
            font-size: 20px;
            font-weight: bold;
            color: red;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="controls">
    <button onclick="exportPoints()">Ekspor JSON</button>
    <input type="file" id="importFile" onchange="importPoints()">
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    // Daftar basemap
    const baseLayers = {
        "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }),
        "Esri World Imagery": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        }),
        "Google Streets": L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            attribution: 'Google'
        }),
        "Google Satellite": L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            attribution: 'Google'
        }),
        "Carto Light": L.tileLayer('https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; Carto'
        }),
        "Carto Dark": L.tileLayer('https://cartodb-basemaps-a.global.ssl.fastly.net/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; Carto'
        })
    };

    // Inisialisasi peta
    const map = L.map('map', {
        center: [-2.5489, 118.0149],
        zoom: 5,
        layers: [baseLayers["OpenStreetMap"]]
    });

    // Layer control
    L.control.layers(baseLayers).addTo(map);

    let points = [];
    let pointCounter = 1;

    // Fungsi membuat marker plus dan lingkaran
    function createCustomMarker(lat, lng, label) {
        const plusIcon = L.divIcon({
            className: 'plus-marker',
            html: '+',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });

        const marker = L.marker([lat, lng], { icon: plusIcon }).addTo(map);
        const circle = L.circleMarker([lat, lng], {
            radius: 12,
            color: 'blue',
            fill: false,
            weight: 2
        }).addTo(map);

        const labelText = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'text-label',
                html: `<div style="color:black;font-weight:bold;background:white;padding:1px 3px;border-radius:3px;border:1px solid gray;">${label}</div>`,
                iconSize: [30, 15],
                iconAnchor: [15, -10]
            }),
            interactive: false
        }).addTo(map);

        return { marker, circle, labelText };
    }

    // Klik di peta untuk menambah titik
    map.on('click', function(e) {
        const { lat, lng } = e.latlng;
        createCustomMarker(lat, lng, pointCounter);
        points.push({ id: pointCounter, lat, lng });
        pointCounter++;
    });

    // Ekspor ke JSON
    function exportPoints() {
        const blob = new Blob([JSON.stringify(points, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'titik.json';
        a.click();
        URL.revokeObjectURL(url);
    }

    // Impor dari JSON
    function importPoints() {
        const fileInput = document.getElementById('importFile');
        const file = fileInput.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                points = [];
                pointCounter = 1;
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
                        map.removeLayer(layer);
                    }
                });
                for (const p of data) {
                    createCustomMarker(p.lat, p.lng, pointCounter);
                    points.push({ id: pointCounter, lat: p.lat, lng: p.lng });
                    pointCounter++;
                }
            } catch (err) {
                alert("File JSON tidak valid!");
            }
        };
        reader.readAsText(file);
    }
</script>

</body>
</html>
