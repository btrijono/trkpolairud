<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta dengan Titik & Print</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-easyprint@2.1.9/dist/bundle.css">
    <style>
        #map { height: 90vh; }
        .label-text {
            background-color: white;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 12px;
            border: 1px solid #555;
        }
    </style>
</head>
<body>

<h3>Peta dengan Titik, Ekspor/Impor JSON, Label, dan Print</h3>
<input type="file" id="importFile" accept=".json">
<button onclick="exportPoints()">Ekspor JSON</button>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-easyprint@2.1.9/dist/bundle.js"></script>

<script>
let map = L.map('map').setView([-0.7893, 113.9213], 5);
let points = [];
let pointCounter = 0;

// ====== Base Maps ======
let baseMaps = {
    "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }),
    "Satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri'
    }),
    "Topographic": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenTopoMap contributors'
    }),
    "Carto Light": L.tileLayer('https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; Carto'
    }),
    "Carto Dark": L.tileLayer('https://cartodb-basemaps-a.global.ssl.fastly.net/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; Carto'
    })
};
baseMaps["OpenStreetMap"].addTo(map);
L.control.layers(baseMaps).addTo(map);

// ====== Print Control ======
L.easyPrint({
    title: 'Print Peta',
    position: 'topleft',
    sizeModes: ['A4Portrait', 'A4Landscape'],
    filename: 'peta',
    exportOnly: false,
    hideControlContainer: false
}).addTo(map);

// ====== Custom Marker (Plus Sign + Circle) ======
let plusIcon = L.divIcon({
    html: '<div style="position: relative; width: 20px; height: 20px; background: white; border-radius: 50%; border: 2px solid red; display: flex; align-items: center; justify-content: center; font-weight: bold; color: red;">+</div>',
    iconSize: [20, 20],
    className: ''
});

// ====== Event Klik di Peta ======
map.on('click', function(e) {
    pointCounter++;
    let marker = L.marker(e.latlng, { icon: plusIcon }).addTo(map);

    // Label nomor titik
    let label = L.marker(e.latlng, {
        icon: L.divIcon({
            className: 'label-text',
            html: pointCounter.toString(),
            iconSize: [20, 20]
        })
    }).addTo(map);

    points.push({ id: pointCounter, lat: e.latlng.lat, lng: e.latlng.lng });
});

// ====== Ekspor Titik ======
function exportPoints() {
    let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(points));
    let dlAnchorElem = document.createElement('a');
    dlAnchorElem.setAttribute("href", dataStr);
    dlAnchorElem.setAttribute("download", "points.json");
    dlAnchorElem.click();
}

// ====== Impor Titik ======
document.getElementById('importFile').addEventListener('change', function(event) {
    let file = event.target.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.onload = function(e) {
        let importedPoints = JSON.parse(e.target.result);
        points = importedPoints;
        pointCounter = points.length;
        points.forEach(p => {
            L.marker([p.lat, p.lng], { icon: plusIcon }).addTo(map);
            L.marker([p.lat, p.lng], {
                icon: L.divIcon({
                    className: 'label-text',
                    html: p.id.toString(),
                    iconSize: [20, 20]
                })
            }).addTo(map);
        });
    };
    reader.readAsText(file);
});
</script>

</body>
</html>
