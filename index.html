<!DOCTYPE html>
<html>
<head>
    <title>Plotting Titik dengan Label & Print</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Leaflet EasyPrint -->
    <script src="https://unpkg.com/leaflet-easyprint@2.1.9/dist/bundle.js"></script>

    <style>
        #map { height: 100vh; }
        .leaflet-control { background: white; padding: 5px; }
    </style>
</head>
<body>

<div id="map"></div>

<script>
let map = L.map('map').setView([-0.7893, 113.9213], 6);

// ===== Pilihan Layer Peta =====
let baseLayers = {
    "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }),
    "Esri World Imagery": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri'
    }),
    "Carto Light": L.tileLayer('https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; Carto'
    }),
    "Carto Dark": L.tileLayer('https://cartodb-basemaps-a.global.ssl.fastly.net/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; Carto'
    }),
    "Stamen Toner": L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
        attribution: '&copy; Stamen Design'
    })
};

baseLayers["OpenStreetMap"].addTo(map);
L.control.layers(baseLayers).addTo(map);

// ===== Data Titik =====
let points = [];
let pointCounter = 0;

// Fungsi Tambah Titik
function addPoint(lat, lng) {
    pointCounter++;
    const pointNumber = pointCounter;

    // Marker plus di dalam lingkaran
    L.marker([lat, lng], {
        icon: L.divIcon({
            html: `<div style="width: 24px; height: 24px; border: 2px solid red; border-radius: 50%; 
                    background-color: white; display: flex; align-items: center; justify-content: center;
                    font-size: 18px; color: red;">+</div>`,
            className: ''
        })
    }).addTo(map);

    // Label nomor titik (selalu terlihat)
    L.marker([lat, lng], {
        icon: L.divIcon({
            html: `<b style="color:black; background:rgba(255,255,255,0.7); padding:1px 4px; border-radius:4px; font-size:12px;">
                    ${pointNumber}</b>`,
            className: '',
            iconAnchor: [-5, -20]
        }),
        interactive: false
    }).addTo(map);

    points.push({ lat, lng, number: pointNumber });
}

// Event klik peta
map.on('click', function(e) {
    addPoint(e.latlng.lat, e.latlng.lng);
});

// ===== Fitur Export JSON =====
function exportJSON() {
    let dataStr = JSON.stringify(points);
    let blob = new Blob([dataStr], { type: "application/json" });
    let url = URL.createObjectURL(blob);

    let a = document.createElement("a");
    a.href = url;
    a.download = "titik.json";
    a.click();
    URL.revokeObjectURL(url);
}

// ===== Fitur Import JSON =====
function importJSON(event) {
    let file = event.target.files[0];
    if (!file) return;
    let reader = new FileReader();
    reader.onload = function(e) {
        let data = JSON.parse(e.target.result);
        points = [];
        pointCounter = 0;
        map.eachLayer(function(layer) {
            if (layer instanceof L.Marker && !layer._url) {
                map.removeLayer(layer);
            }
        });
        data.forEach(p => addPoint(p.lat, p.lng));
    };
    reader.readAsText(file);
}

// ===== Tombol Export/Import =====
L.control.custom = function(opts) {
    let control = L.Control.extend({
        options: { position: opts.position },
        onAdd: function() {
            let div = L.DomUtil.create('div', 'leaflet-control');
            div.innerHTML = `
                <button onclick="exportJSON()">Export JSON</button>
                <input type="file" onchange="importJSON(event)" style="margin-top:5px;">
            `;
            return div;
        }
    });
    return new control();
};
map.addControl(new (L.control.custom({ position: 'topright' })));

// ===== Menu Print =====
L.easyPrint({
    title: 'Print Peta',
    position: 'topleft',
    sizeModes: ['A4Portrait', 'A4Landscape'],
    filename: 'peta_dengan_nomor',
    exportOnly: false,
    hideControlContainer: false
}).addTo(map);

</script>

</body>
</html>
