<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Peta Titik dengan Export/Import dan Print</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  #map { height: 90vh; width: 100%; }
  .marker-label {
      background-color: white;
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 12px;
      border: 1px solid gray;
  }
</style>
</head>
<body>

<div id="map"></div>
<div style="padding:10px;">
    <button id="add-point">Tambah Titik</button>
    <button id="clear-points">Hapus Semua Titik</button>
    <button id="export-json">Export JSON</button>
    <input type="file" id="import-json" accept=".json">
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Leaflet EasyPrint -->
<script src="https://unpkg.com/leaflet-easyprint/dist/bundle.js"></script>

<script>
let map, pointsLayer, pointCounter = 0, pointsData = [];

// Inisialisasi peta
map = L.map('map').setView([-0.7893, 113.9213], 6);

// Pilihan Base Map
var baseLayers = {
    "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap', maxZoom: 19
    }),
    "Google Satellite": L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        attribution: 'Google', maxZoom: 20
    }),
    "Google Streets": L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
        attribution: 'Google', maxZoom: 20
    }),
    "Esri World Imagery": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles © Esri', maxZoom: 20
    }),
    "Carto Light": L.tileLayer('https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '© Carto', subdomains: 'abcd', maxZoom: 20
    }),
    "Carto Dark": L.tileLayer('https://cartodb-basemaps-a.global.ssl.fastly.net/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '© Carto', subdomains: 'abcd', maxZoom: 20
    })
};

// Tambahkan layer default
baseLayers["OpenStreetMap"].addTo(map);

// Layer titik
pointsLayer = L.layerGroup().addTo(map);

// Kontrol layer
L.control.layers(baseLayers, { "Titik": pointsLayer }).addTo(map);

// Plugin print peta
L.easyPrint({
    title: 'Print Peta',
    position: 'topleft',
    sizeModes: ['Current', 'A4Landscape', 'A4Portrait'],
    filename: 'peta_titik',
    exportOnly: true
}).addTo(map);

// Fungsi tambah titik
function addPoint() {
    let latlng = map.getCenter(); // untuk contoh, titiknya di tengah peta
    pointCounter++;
    let label = pointCounter.toString();

    // Marker custom (tanda plus di lingkaran)
    let marker = L.marker(latlng, {
        icon: L.divIcon({
            html: `<div style="text-align:center;">
                     <svg width="20" height="20">
                       <circle cx="10" cy="10" r="8" stroke="red" stroke-width="2" fill="white"/>
                       <line x1="10" y1="4" x2="10" y2="16" stroke="red" stroke-width="2"/>
                       <line x1="4" y1="10" x2="16" y2="10" stroke="red" stroke-width="2"/>
                     </svg>
                   </div>`,
            className: '',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        })
    }).addTo(pointsLayer);

    // Label nomor titik
    L.marker([latlng.lat, latlng.lng], {
        icon: L.divIcon({
            className: 'marker-label',
            html: label,
            iconSize: [20, 20],
            iconAnchor: [10, -10]
        })
    }).addTo(pointsLayer);

    pointsData.push({ id: label, lat: latlng.lat, lng: latlng.lng });
}

// Fungsi hapus semua titik
function clearPoints() {
    pointsLayer.clearLayers();
    pointCounter = 0;
    pointsData = [];
}

// Export JSON
function exportPoints() {
    let blob = new Blob([JSON.stringify(pointsData, null, 2)], { type: "application/json" });
    let url = URL.createObjectURL(blob);
    let a = document.createElement("a");
    a.href = url;
    a.download = "titik.json";
    a.click();
}

// Import JSON
function importPoints(evt) {
    let file = evt.target.files[0];
    if (!file) return;
    let reader = new FileReader();
    reader.onload = function(e) {
        let imported = JSON.parse(e.target.result);
        clearPoints();
        imported.forEach(p => {
            pointCounter++;
            let marker = L.marker([p.lat, p.lng], {
                icon: L.divIcon({
                    html: `<div style="text-align:center;">
                             <svg width="20" height="20">
                               <circle cx="10" cy="10" r="8" stroke="red" stroke-width="2" fill="white"/>
                               <line x1="10" y1="4" x2="10" y2="16" stroke="red" stroke-width="2"/>
                               <line x1="4" y1="10" x2="16" y2="10" stroke="red" stroke-width="2"/>
                             </svg>
                           </div>`,
                    className: '',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(pointsLayer);

            L.marker([p.lat, p.lng], {
                icon: L.divIcon({
                    className: 'marker-label',
                    html: p.id,
                    iconSize: [20, 20],
                    iconAnchor: [10, -10]
                })
            }).addTo(pointsLayer);
        });
        pointsData = imported;
    };
    reader.readAsText(file);
}

// Event tombol
document.getElementById("add-point").addEventListener("click", addPoint);
document.getElementById("clear-points").addEventListener("click", clearPoints);
document.getElementById("export-json").addEventListener("click", exportPoints);
document.getElementById("import-json").addEventListener("change", importPoints);

</script>
</body>
</html>
